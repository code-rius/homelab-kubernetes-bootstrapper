# Radicale CalDAV/CardDAV Server

Simple CalDAV and CardDAV server for calendars and contacts with HTTPS via cert-manager.

## Quick Deploy

```bash
# 1. Create NFS directory on Proxmox
ssh coderius@192.168.1.150 "sudo mkdir -p /ZFS01/nfs-storage/radicale-data && sudo chmod 777 /ZFS01/nfs-storage/radicale-data"

# 2. Deploy (cert-manager auto-generates SSL cert)
make deploy-radicale

# 3. Install CA certificate on iOS/macOS (first time only)
# AirDrop certs/ca/ca.crt to your device
# Open → Install → Settings → General → About → Certificate Trust Settings → Enable

# 4. Create user
kubectl exec -n radicale deployment/radicale -c radicale -- htpasswd -B -c /data/users username
```

**Access**: `https://radicale.tail060ef.ts.net`

## SSL Certificate Management

Certificates are automatically managed by cert-manager:
- **CA**: Homelab Root CA (`certs/ca/ca.crt`)
- **Certificate**: Auto-issued by cert-manager, stored in `radicale-tls` secret
- **Validity**: 1 year, auto-renewed 30 days before expiry
- **Persistence**: Survives pod restarts and cluster recreation

**Important**: Only the CA needs to be installed on devices once. Service certificates are automatically managed.

## Storage (NFS)

- **radicale-data**: 5Gi at `/data`
- Contains: collections, users file, config

Data survives pod restarts, node failures, and cluster recreation!

## User Management

```bash
# Create first user
kubectl exec -n radicale -it deployment/radicale -c radicale -- htpasswd -B -c /data/users username

# Add additional users
kubectl exec -n radicale -it deployment/radicale -c radicale -- htpasswd -B /data/users username2

# View users
kubectl exec -n radicale deployment/radicale -c radicale -- cat /data/users
```

## Client Setup

### iOS/macOS
1. Settings → Passwords & Accounts → Add Account → Other
2. Add CalDAV/CardDAV Account
3. Server: `radicale.tail060ef.ts.net`
4. Username/Password: created above
5. Port: 443 (HTTPS)

### Thunderbird
1. Install CardBook add-on for contacts
2. Calendar: Right-click calendar list → New Calendar → On Network → CalDAV
3. URL: `https://radicale.tail060ef.ts.net/username/`
4. Contacts: CardBook → New Address Book → Remote → CardDAV
5. URL: `https://radicale.tail060ef.ts.net/username/`

## Management

```bash
# Status
kubectl get all -n radicale
kubectl get pvc -n radicale

# Logs
kubectl logs -n radicale -l app=radicale -f

# Restart
kubectl rollout restart deployment/radicale -n radicale

# Shell access
kubectl exec -n radicale -it deployment/radicale -- /bin/sh
```

## Troubleshooting

```bash
# Pod not starting
kubectl get pods -n radicale
kubectl logs -n radicale -l app=radicale -c radicale --tail=100
kubectl logs -n radicale -l app=radicale -c nginx --tail=100

# Check certificate status
kubectl get certificate -n radicale
kubectl describe certificate radicale-tls -n radicale

# Tailscale issues
kubectl get svc -n radicale radicale  # Check external IP
kubectl get pods -n tailscale
kubectl logs -n tailscale -l tailscale.com/parent-resource=radicale

# Storage issues
kubectl get pvc -n radicale  # Should show Bound
```

## Cleanup

```bash
kubectl delete namespace radicale
make cleanup-tailscale-device
# NFS data persists - delete manually on Proxmox if needed
```

## Certificate Backup

**What to backup**:
- `certs/ca/ca.crt` - Root CA public certificate (install on devices)
- `certs/ca/ca.key` - Root CA private key (keep secret, enables signing)

Service certificates (like radicale-tls) are automatically regenerated by cert-manager and don't need backup.
