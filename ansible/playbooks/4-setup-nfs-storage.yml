---
- name: Install NFS client on all nodes
  hosts: k8s_cluster
  become: true
  tasks:
    - name: Install NFS client packages
      apt:
        name:
          - nfs-common
        state: present
        update_cache: yes

    - name: Ensure NFS client services are enabled
      systemd:
        name: "{{ item }}"
        enabled: yes
        state: started
      loop:
        - rpc-statd
        - nfs-client.target

- name: Deploy NFS provisioner to cluster
  hosts: master
  become: false
  tasks:
    - name: Create nfs-provisioner namespace
      command: kubectl create namespace nfs-provisioner
      register: namespace_result
      failed_when: false
      changed_when: namespace_result.rc == 0

    - name: Create temp directory for k8s manifests
      file:
        path: /tmp/nfs-provisioner
        state: directory
        mode: '0755'

    - name: Copy NFS provisioner manifests to master
      copy:
        src: "{{ playbook_dir }}/../resources/{{ item }}"
        dest: "/tmp/nfs-provisioner/{{ item }}"
        mode: '0644'
      loop:
        - nfs-provisioner-rbac.yml
        - nfs-provisioner-deployment.yml
        - nfs-storageclass.yml

    - name: Apply NFS provisioner RBAC
      command: kubectl apply -f /tmp/nfs-provisioner/nfs-provisioner-rbac.yml

    - name: Apply NFS provisioner deployment
      command: kubectl apply -f /tmp/nfs-provisioner/nfs-provisioner-deployment.yml

    - name: Apply NFS StorageClass
      command: kubectl apply -f /tmp/nfs-provisioner/nfs-storageclass.yml

    - name: Wait for NFS provisioner to be ready
      command: kubectl wait --for=condition=available --timeout=120s deployment/nfs-client-provisioner -n nfs-provisioner
      register: wait_result
      retries: 3
      delay: 10
      until: wait_result.rc == 0
      ignore_errors: yes

    - name: Check NFS provisioner pod status if wait failed
      command: kubectl describe pod -n nfs-provisioner -l app=nfs-client-provisioner
      when: wait_result is failed
      register: pod_describe
      ignore_errors: yes

    - name: Display pod describe output
      debug:
        msg: "{{ pod_describe.stdout_lines }}"
      when: wait_result is failed and pod_describe is defined

    - name: Get storage classes
      command: kubectl get storageclass
      register: storageclass_output
      changed_when: false

    - name: Display storage classes
      debug:
        msg: "{{ storageclass_output.stdout_lines }}"
