---
- name: Generate Kubernetes configuration files
  hosts: localhost
  gather_facts: false
  vars:
    cert_dir: "{{ playbook_dir }}/../certs"
    api_server: "https://{{ hostvars['k8s-master'].ansible_host }}:6443"
  tasks:
    - name: Generate kubeconfig for worker nodes
      shell: |
        kubectl config set-cluster {{ cluster_name }} \
          --certificate-authority={{ cert_dir }}/ca.crt \
          --embed-certs=true \
          --server={{ api_server }} \
          --kubeconfig={{ cert_dir }}/{{ item }}.kubeconfig

        kubectl config set-credentials system:node:{{ item }} \
          --client-certificate={{ cert_dir }}/{{ item }}.crt \
          --client-key={{ cert_dir }}/{{ item }}.key \
          --embed-certs=true \
          --kubeconfig={{ cert_dir }}/{{ item }}.kubeconfig

        kubectl config set-context default \
          --cluster={{ cluster_name }} \
          --user=system:node:{{ item }} \
          --kubeconfig={{ cert_dir }}/{{ item }}.kubeconfig

        kubectl config use-context default \
          --kubeconfig={{ cert_dir }}/{{ item }}.kubeconfig
      args:
        creates: "{{ cert_dir }}/{{ item }}.kubeconfig"
      loop: "{{ groups['workers'] }}"

    - name: Generate kubeconfig for kube-proxy
      shell: |
        kubectl config set-cluster {{ cluster_name }} \
          --certificate-authority={{ cert_dir }}/ca.crt \
          --embed-certs=true \
          --server={{ api_server }} \
          --kubeconfig={{ cert_dir }}/kube-proxy.kubeconfig

        kubectl config set-credentials system:kube-proxy \
          --client-certificate={{ cert_dir }}/kube-proxy.crt \
          --client-key={{ cert_dir }}/kube-proxy.key \
          --embed-certs=true \
          --kubeconfig={{ cert_dir }}/kube-proxy.kubeconfig

        kubectl config set-context default \
          --cluster={{ cluster_name }} \
          --user=system:kube-proxy \
          --kubeconfig={{ cert_dir }}/kube-proxy.kubeconfig

        kubectl config use-context default \
          --kubeconfig={{ cert_dir }}/kube-proxy.kubeconfig
      args:
        creates: "{{ cert_dir }}/kube-proxy.kubeconfig"

    - name: Generate kubeconfig for kube-controller-manager
      shell: |
        kubectl config set-cluster {{ cluster_name }} \
          --certificate-authority={{ cert_dir }}/ca.crt \
          --embed-certs=true \
          --server=https://127.0.0.1:6443 \
          --kubeconfig={{ cert_dir }}/kube-controller-manager.kubeconfig

        kubectl config set-credentials system:kube-controller-manager \
          --client-certificate={{ cert_dir }}/kube-controller-manager.crt \
          --client-key={{ cert_dir }}/kube-controller-manager.key \
          --embed-certs=true \
          --kubeconfig={{ cert_dir }}/kube-controller-manager.kubeconfig

        kubectl config set-context default \
          --cluster={{ cluster_name }} \
          --user=system:kube-controller-manager \
          --kubeconfig={{ cert_dir }}/kube-controller-manager.kubeconfig

        kubectl config use-context default \
          --kubeconfig={{ cert_dir }}/kube-controller-manager.kubeconfig
      args:
        creates: "{{ cert_dir }}/kube-controller-manager.kubeconfig"

    - name: Generate kubeconfig for kube-scheduler
      shell: |
        kubectl config set-cluster {{ cluster_name }} \
          --certificate-authority={{ cert_dir }}/ca.crt \
          --embed-certs=true \
          --server=https://127.0.0.1:6443 \
          --kubeconfig={{ cert_dir }}/kube-scheduler.kubeconfig

        kubectl config set-credentials system:kube-scheduler \
          --client-certificate={{ cert_dir }}/kube-scheduler.crt \
          --client-key={{ cert_dir }}/kube-scheduler.key \
          --embed-certs=true \
          --kubeconfig={{ cert_dir }}/kube-scheduler.kubeconfig

        kubectl config set-context default \
          --cluster={{ cluster_name }} \
          --user=system:kube-scheduler \
          --kubeconfig={{ cert_dir }}/kube-scheduler.kubeconfig

        kubectl config use-context default \
          --kubeconfig={{ cert_dir }}/kube-scheduler.kubeconfig
      args:
        creates: "{{ cert_dir }}/kube-scheduler.kubeconfig"

    - name: Generate kubeconfig for admin
      shell: |
        kubectl config set-cluster {{ cluster_name }} \
          --certificate-authority={{ cert_dir }}/ca.crt \
          --embed-certs=true \
          --server=https://127.0.0.1:6443 \
          --kubeconfig={{ cert_dir }}/admin.kubeconfig

        kubectl config set-credentials admin \
          --client-certificate={{ cert_dir }}/admin.crt \
          --client-key={{ cert_dir }}/admin.key \
          --embed-certs=true \
          --kubeconfig={{ cert_dir }}/admin.kubeconfig

        kubectl config set-context default \
          --cluster={{ cluster_name }} \
          --user=admin \
          --kubeconfig={{ cert_dir }}/admin.kubeconfig

        kubectl config use-context default \
          --kubeconfig={{ cert_dir }}/admin.kubeconfig
      args:
        creates: "{{ cert_dir }}/admin.kubeconfig"

    - name: Fix kubeconfig file permissions
      file:
        path: "{{ cert_dir }}/{{ item }}"
        mode: '0644'
      loop:
        - admin.kubeconfig
        - kube-proxy.kubeconfig
        - kube-controller-manager.kubeconfig
        - kube-scheduler.kubeconfig
      ignore_errors: yes

    - name: Fix worker kubeconfig permissions
      file:
        path: "{{ cert_dir }}/{{ item }}.kubeconfig"
        mode: '0644'
      loop: "{{ groups['workers'] }}"
      ignore_errors: yes

- name: Distribute kubeconfig files to worker nodes
  hosts: workers
  become: true
  vars:
    cert_dir: "{{ hostvars['localhost']['cert_dir'] | default(playbook_dir + '/../certs') }}"
  tasks:
    - name: Create directories for kubelet and kube-proxy
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - /var/lib/kubelet
        - /var/lib/kube-proxy

    - name: Copy kubelet kubeconfig to workers
      copy:
        src: "{{ cert_dir }}/{{ inventory_hostname }}.kubeconfig"
        dest: /var/lib/kubelet/kubeconfig
        mode: '0644'

    - name: Copy kube-proxy kubeconfig to workers
      copy:
        src: "{{ cert_dir }}/kube-proxy.kubeconfig"
        dest: /var/lib/kube-proxy/kubeconfig
        mode: '0644'

- name: Distribute kubeconfig files to master node
  hosts: master
  become: true
  vars:
    cert_dir: "{{ hostvars['localhost']['cert_dir'] | default(playbook_dir + '/../certs') }}"
  tasks:
    - name: Copy master kubeconfig files
      copy:
        src: "{{ cert_dir }}/{{ item }}.kubeconfig"
        dest: "/root/{{ item }}.kubeconfig"
        mode: '0600'
      loop:
        - admin
        - kube-controller-manager
        - kube-scheduler
