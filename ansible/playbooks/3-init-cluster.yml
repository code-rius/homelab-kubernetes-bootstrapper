---
- name: Initialize Kubernetes cluster with kubeadm
  hosts: master
  become: true
  tasks:
    - name: Check if cluster is already initialized
      stat:
        path: /etc/kubernetes/admin.conf
      register: kubeadm_initialized

    - name: Initialize Kubernetes cluster
      command: >
        kubeadm init
        --pod-network-cidr={{ cluster_cidr }}
        --service-cidr={{ service_cidr }}
        --apiserver-advertise-address={{ ansible_host }}
      register: kubeadm_init_output
      when: not kubeadm_initialized.stat.exists

    - name: Create .kube directory for root
      file:
        path: /root/.kube
        state: directory
        mode: '0755'

    - name: Copy admin.conf to .kube/config
      copy:
        src: /etc/kubernetes/admin.conf
        dest: /root/.kube/config
        remote_src: yes
        mode: '0600'
      when: not kubeadm_initialized.stat.exists

    - name: Create .kube directory for ansible user
      file:
        path: "/home/{{ ansible_user }}/.kube"
        state: directory
        mode: '0755'
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"

    - name: Copy admin.conf to ansible user
      copy:
        src: /etc/kubernetes/admin.conf
        dest: "/home/{{ ansible_user }}/.kube/config"
        remote_src: yes
        mode: '0600'
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"

    - name: Get join command
      command: kubeadm token create --print-join-command
      register: join_command
      changed_when: false

    - name: Save join command to local file
      copy:
        content: "{{ join_command.stdout }}"
        dest: "{{ playbook_dir }}/../.kubeadm-join-command"
      delegate_to: localhost
      become: false

- name: Join worker nodes to cluster
  hosts: workers
  become: true
  tasks:
    - name: Check if node is already joined
      stat:
        path: /etc/kubernetes/kubelet.conf
      register: node_joined

    - name: Read join command from file
      set_fact:
        join_command: "{{ lookup('file', playbook_dir + '/../.kubeadm-join-command') }}"
      when: not node_joined.stat.exists

    - name: Join node to cluster
      command: "{{ join_command }}"
      when: not node_joined.stat.exists

- name: Install CNI plugin (Flannel)
  hosts: master
  become: true
  tasks:
    - name: Check if Flannel is already installed
      command: kubectl get daemonset -n kube-flannel kube-flannel-ds
      register: flannel_check
      failed_when: false
      changed_when: false

    - name: Install Flannel CNI
      command: kubectl apply -f https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml
      when: flannel_check.rc != 0

    - name: Wait for all nodes to be ready
      command: kubectl get nodes -o jsonpath='{range .items[*]}{.metadata.name}{"\t"}{.status.conditions[?(@.type=="Ready")].status}{"\n"}{end}'
      register: nodes_status
      until: nodes_status.stdout.find('False') == -1 and nodes_status.stdout.find('Unknown') == -1
      retries: 60
      delay: 5
      changed_when: false

    - name: Get current CoreDNS ConfigMap
      command: kubectl get configmap coredns -n kube-system -o yaml
      register: coredns_config
      changed_when: false

    - name: Check if CoreDNS forward is configured correctly
      set_fact:
        needs_dns_fix: "{{ 'forward . 8.8.8.8 8.8.4.4' not in coredns_config.stdout }}"

    - name: Fix CoreDNS to use external DNS servers
      shell: |
        kubectl get configmap coredns -n kube-system -o yaml | \
        sed 's|forward \. /etc/resolv.conf {|forward . 8.8.8.8 8.8.4.4 {|g' | \
        kubectl apply -f -
      when: needs_dns_fix
      register: dns_update

    - name: Restart CoreDNS to apply DNS fix
      command: kubectl rollout restart deployment/coredns -n kube-system
      when: needs_dns_fix

    - name: Wait for CoreDNS to be ready after restart
      command: kubectl wait --for=condition=available --timeout=120s deployment/coredns -n kube-system
      when: needs_dns_fix
